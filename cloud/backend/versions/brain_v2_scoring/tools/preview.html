<!doctype html>
<html>
  <body>
    <div style="font-family: sans-serif; margin-bottom: 8px;">
      <label for="template">Template:</label>
      <select id="template">
        <option value="circle_v1">Circle</option>
        <option value="triangle_v1">Triangle</option>
        <option value="heart_v1">Heart</option>
        <option value="sine_v1">Sine</option>
        <option value="infinity_v1">Infinity</option>
      </select>
      <span id="status" style="margin-left: 10px;">waiting...</span>
      <span id="score" style="margin-left: 10px; font-weight: 700;"></span>
    </div>
    <div style="position: relative; width: 256px; height: 256px; border:1px solid #999; background:#0c0c0c;">
      <img id="bg" width="256" height="256" style="position:absolute; left:0; top:0; opacity:0.52; image-rendering:pixelated;" />
      <img id="draw" width="256" height="256" style="position:absolute; left:0; top:0; image-rendering:pixelated; mix-blend-mode: screen; opacity:0.96;" />
    </div>
    <script>
      const bg = document.getElementById("bg");
      const draw = document.getElementById("draw");
      const templateSel = document.getElementById("template");
      const statusEl = document.getElementById("status");
      const scoreEl = document.getElementById("score");
      const params = new URLSearchParams(window.location.search);
      const defaultApiBase = `${window.location.protocol}//${window.location.hostname}:8000`;
      const API_BASE = params.get("api") || defaultApiBase;
      const WAND_ID = Number(params.get("wand") || "1");
      const INTERVAL_MS = Number(params.get("ms") || "200");
      const initialTemplate = params.get("template") || "circle_v1";
      let hasFrame = false;
      let lastShownAttempt = null;
      templateSel.value = initialTemplate;

      function setTemplateImage() {
        const tid = templateSel.value;
        bg.src = `${API_BASE}/api/v2/template/${tid}/image.png?t=${Date.now()}`;
        scoreEl.textContent = "";
      }

      templateSel.addEventListener("change", setTemplateImage);
      setTemplateImage();

      draw.onerror = () => {
        if (!hasFrame) {
          statusEl.textContent = `live image not available yet (wand=${WAND_ID})`;
        }
      };

      function tick() {
        const ts = Date.now();
        const liveUrl = `${API_BASE}/api/v1/wand/${WAND_ID}/live.png?t=${ts}`;
        // Preload first, then swap in only on success to avoid flicker on transient failures.
        const next = new Image();
        next.onload = () => {
          draw.src = liveUrl;
          hasFrame = true;
          statusEl.textContent =
            `wand=${WAND_ID} template=${templateSel.value} live @ ${new Date(ts).toLocaleTimeString()}`;
        };
        next.onerror = () => {
          if (!hasFrame) {
            statusEl.textContent = `live image not available yet (wand=${WAND_ID})`;
          }
        };
        next.src = liveUrl;
      }

      setInterval(tick, INTERVAL_MS);
      tick();

      async function scoreTick() {
        try {
          const wandResp = await fetch(`${API_BASE}/api/v1/wand/${WAND_ID}`, { cache: "no-store" });
          if (!wandResp.ok) return;
          const wand = await wandResp.json();

          if (wand.active) {
            scoreEl.textContent = "drawing...";
            return;
          }

          const scoreResp = await fetch(
            `${API_BASE}/api/v2/score/latest?wand_id=${WAND_ID}&template_id=${templateSel.value}`,
            { cache: "no-store" }
          );
          if (!scoreResp.ok) return;
          const payload = await scoreResp.json();
          const attemptId = payload.attempt_id;
          if (attemptId !== lastShownAttempt) {
            lastShownAttempt = attemptId;
          }
          const s = payload.best?.score;
          scoreEl.textContent = `final score: ${s}`;
        } catch (_e) {
          // keep UI running even if score endpoint is temporarily unavailable
        }
      }

      setInterval(scoreTick, 700);
      scoreTick();
    </script>
  </body>
</html>
