<!doctype html>
<html>
  <body>
    <p id="status">waiting...</p>
    <img id="img" width="256" height="256" style="border:1px solid #999" />
    <script>
      const img = document.getElementById("img");
      const statusEl = document.getElementById("status");
      const params = new URLSearchParams(window.location.search);
      const defaultApiBase = `${window.location.protocol}//${window.location.hostname}:8000`;
      const API_BASE = params.get("api") || defaultApiBase;
      const WAND_ID = Number(params.get("wand") || "1");
      const INTERVAL_MS = Number(params.get("ms") || "200");
      let hasFrame = false;

      img.onerror = () => {
        if (!hasFrame) {
          statusEl.textContent = `live image not available yet (wand=${WAND_ID})`;
        }
      };

      function tick() {
        const ts = Date.now();
        const liveUrl = `${API_BASE}/api/v1/wand/${WAND_ID}/live.png?t=${ts}`;
        // Preload first, then swap in only on success to avoid flicker on transient failures.
        const next = new Image();
        next.onload = () => {
          img.src = liveUrl;
          hasFrame = true;
          statusEl.textContent = `wand=${WAND_ID} live @ ${new Date(ts).toLocaleTimeString()}`;
        };
        next.onerror = () => {
          if (!hasFrame) {
            statusEl.textContent = `live image not available yet (wand=${WAND_ID})`;
          }
        };
        next.src = liveUrl;
      }

      setInterval(tick, INTERVAL_MS);
      tick();
    </script>
  </body>
</html>
